<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Submission Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 60px; }
        .navbar-brand { font-weight: bold; }
        .stats-card { 
            border-radius: 10px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stats-card:hover { transform: translateY(-2px); }
        .upload-zone {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-zone:hover {
            background: #e9ecef;
            border-color: #0056b3;
        }
        .upload-zone.dragover {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .api-status { margin-right: 20px; }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .modal-xl { max-width: 90%; }
        #detail-content { max-height: 70vh; overflow-y: auto; }
        #detail-content table th { 
            background-color: #f8f9fa; 
            font-weight: 600;
            color: #495057;
        }
        #detail-content code { 
            background-color: #f1f3f4; 
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">üß¨ HTSF PDF Tracker</a>
            <div class="navbar-text api-status">
                <span class="status-indicator" id="api-status"></span>
                <span id="api-status-text">Checking API...</span>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mt-4">
        <!-- Statistics Cards -->
        <div class="row mb-4" id="stats-row">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Submissions</h6>
                        <h2 id="total-submissions">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Total Samples</h6>
                        <h2 id="total-samples">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Unique Projects</h6>
                        <h2 id="unique-projects">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <h6 class="text-muted">Avg Concentration</h6>
                        <h2 id="avg-concentration">-</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#upload">Upload PDF</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#submissions">Submissions</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#search">Search</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Upload Tab -->
            <div class="tab-pane fade show active" id="upload">
                <div class="upload-zone" id="dropZone">
                    <h4>üìÑ Drop PDF Here</h4>
                    <p class="text-muted">or click to select a file</p>
                    <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    <button class="btn btn-primary mt-3" onclick="document.getElementById('fileInput').click()">
                        Select PDF File
                    </button>
                </div>
                <div id="upload-result" class="mt-4"></div>
            </div>

            <!-- Submissions Tab -->
            <div class="tab-pane fade" id="submissions">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Submission ID</th>
                                <th>Project</th>
                                <th>Owner</th>
                                <th>Samples</th>
                                <th>Scanned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="submissions-table">
                            <tr><td colspan="6" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Search Tab -->
            <div class="tab-pane fade" id="search">
                <div class="row mb-4">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="search-input" 
                               placeholder="Search by project ID, owner, organism...">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="performSearch()">
                            üîç Search
                        </button>
                    </div>
                </div>
                <div id="search-results"></div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">üìã Submission Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detail-content">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="downloadSubmissionData()">üì• Download JSON</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Submission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="edit-submission-id">
                        
                        <div class="mb-3">
                            <label class="form-label">Submission ID</label>
                            <input type="text" class="form-control" id="edit-submission-id-display" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Project ID</label>
                            <input type="text" class="form-control" id="edit-project-id" 
                                   placeholder="e.g., HTSF--XX-XXX">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Owner</label>
                            <input type="text" class="form-control" id="edit-owner" 
                                   placeholder="Name (Lab)">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Source Organism</label>
                            <input type="text" class="form-control" id="edit-source-organism" 
                                   placeholder="e.g., Human, Mouse, etc.">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="edit-location" 
                                   placeholder="e.g., Building/Room number, Lab name">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Total Samples</label>
                            <input type="text" class="form-control" id="edit-total-samples" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Scanned At</label>
                            <input type="text" class="form-control" id="edit-scanned-at" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">PDF Filename</label>
                            <input type="text" class="form-control" id="edit-pdf-filename" readonly>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <small><strong>Note:</strong> Only Project ID, Owner, Source Organism, and Location can be edited. 
                            To modify sample data or other fields, please upload a new PDF.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSubmissionChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8000';
        
        // Check API status
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    document.getElementById('api-status').className = 'status-indicator status-online';
                    document.getElementById('api-status-text').textContent = 'API Online';
                    return true;
                }
            } catch (error) {
                console.error('API connection error:', error);
            }
            document.getElementById('api-status').className = 'status-indicator status-offline';
            document.getElementById('api-status-text').textContent = 'API Offline';
            return false;
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_URL}/api/statistics`);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('total-submissions').textContent = stats.total_submissions || 0;
                    document.getElementById('total-samples').textContent = stats.total_samples || 0;
                    document.getElementById('unique-projects').textContent = stats.unique_projects || 0;
                    
                    if (stats.concentration_stats && stats.concentration_stats.avg_concentration) {
                        document.getElementById('avg-concentration').textContent = 
                            stats.concentration_stats.avg_concentration.toFixed(2) + ' ng/¬µL';
                    }
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load submissions
        async function loadSubmissions() {
            try {
                const response = await fetch(`${API_URL}/api/submissions`);
                if (response.ok) {
                    const submissions = await response.json();
                    const tbody = document.getElementById('submissions-table');
                    
                    if (submissions.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No submissions found</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = submissions.map(sub => `
                        <tr>
                            <td><small>${sub.submission_id}</small></td>
                            <td>${sub.project_id || 'N/A'}</td>
                            <td>${sub.owner || 'N/A'}</td>
                            <td>${sub.total_samples}</td>
                            <td>${new Date(sub.scanned_at).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="viewDetailedSubmission('${sub.submission_id}')">
                                    View
                                </button>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="viewSubmission('${sub.submission_id}')">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('submissions-table').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading submissions</td></tr>';
            }
        }

        // View/Edit submission details
        async function viewSubmission(id) {
            try {
                const response = await fetch(`${API_URL}/api/submissions/${id}`);
                if (response.ok) {
                    const submission = await response.json();
                    
                    // Populate the edit modal
                    document.getElementById('edit-submission-id').value = submission.submission_id;
                    document.getElementById('edit-submission-id-display').value = submission.submission_id;
                    document.getElementById('edit-project-id').value = submission.project_id || '';
                    document.getElementById('edit-owner').value = submission.owner || '';
                    document.getElementById('edit-source-organism').value = submission.source_organism || '';
                    document.getElementById('edit-location').value = submission.location || '';
                    document.getElementById('edit-total-samples').value = submission.total_samples;
                    document.getElementById('edit-scanned-at').value = new Date(submission.scanned_at).toLocaleString();
                    document.getElementById('edit-pdf-filename').value = submission.pdf_filename;
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('editModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error viewing submission:', error);
                alert('Error loading submission details');
            }
        }
        
        // Save submission changes
        async function saveSubmissionChanges() {
            const submissionId = document.getElementById('edit-submission-id').value;
            const updateData = {
                project_id: document.getElementById('edit-project-id').value || null,
                owner: document.getElementById('edit-owner').value || null,
                source_organism: document.getElementById('edit-source-organism').value || null,
                location: document.getElementById('edit-location').value || null
            };
            
            try {
                const response = await fetch(`${API_URL}/api/submissions/${submissionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
                        modal.hide();
                        
                        // Show success message
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                        alertDiv.style.zIndex = '9999';
                        alertDiv.innerHTML = `
                            <strong>Success!</strong> Submission updated successfully.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(alertDiv);
                        
                        // Auto-dismiss after 3 seconds
                        setTimeout(() => {
                            alertDiv.remove();
                        }, 3000);
                        
                        // Refresh the submissions list if on that tab
                        if (document.querySelector('#submissions').classList.contains('active')) {
                            loadSubmissions();
                        }
                        
                        // Refresh statistics
                        loadStatistics();
                    } else {
                        alert('Update failed: ' + (result.message || 'Unknown error'));
                    }
                } else {
                    throw new Error('Update request failed');
                }
            } catch (error) {
                console.error('Error updating submission:', error);
                alert('Error updating submission. Please try again.');
            }
        }

        // Search functionality
        async function performSearch() {
            const query = document.getElementById('search-input').value;
            if (!query) return;
            
            try {
                const response = await fetch(`${API_URL}/api/search?q=${encodeURIComponent(query)}`);
                if (response.ok) {
                    const result = await response.json();
                    const resultsDiv = document.getElementById('search-results');
                    
                    if (result.count === 0) {
                        resultsDiv.innerHTML = '<div class="alert alert-info">No results found</div>';
                        return;
                    }
                    
                    resultsDiv.innerHTML = `
                        <h5>Found ${result.count} result(s)</h5>
                        <div class="list-group">
                            ${result.results.map(sub => `
                                <div class="list-group-item">
                                    <h6>${sub.submission_id}</h6>
                                    <p class="mb-1">Project: ${sub.project_id || 'N/A'}</p>
                                    <small>Owner: ${sub.owner || 'N/A'} | Samples: ${sub.total_samples}</small>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                uploadFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadFile(e.target.files[0]);
            }
        });

        async function uploadFile(file) {
            const resultDiv = document.getElementById('upload-result');
            resultDiv.innerHTML = '<div class="alert alert-info">Uploading and processing...</div>';
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_URL}/api/process?save_to_db=true`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.is_duplicate) {
                        resultDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <h5>‚ö†Ô∏è Duplicate Detected</h5>
                                <p>${result.message}</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h5>‚úÖ Upload Successful</h5>
                                <p>Submission ID: ${result.submission_id}</p>
                                <p>${result.message}</p>
                            </div>
                        `;
                    }
                    
                    // Reload statistics and submissions
                    loadStatistics();
                    loadSubmissions();
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>‚ùå Upload Failed</h5>
                        <p>Please ensure the API server is running and try again.</p>
                    </div>
                `;
            }
        }

        // Tab change handler
        document.querySelectorAll('a[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', (e) => {
                if (e.target.getAttribute('href') === '#submissions') {
                    loadSubmissions();
                }
            });
        });

        // Store current detailed submission for download
        let currentDetailedSubmission = null;
        
        // View detailed submission
        async function viewDetailedSubmission(id) {
            try {
                const response = await fetch(`${API_URL}/api/submissions/${id}/detailed`);
                if (response.ok) {
                    const submission = await response.json();
                    currentDetailedSubmission = submission;
                    
                    // Build the detail HTML
                    let detailHtml = `
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">üìå Basic Information</h6>
                                <table class="table table-sm">
                                    <tr><th width="40%">Submission ID:</th><td><code>${submission.submission_id || 'N/A'}</code></td></tr>
                                    <tr><th>Project ID:</th><td>${submission.project_id || 'N/A'}</td></tr>
                                    <tr><th>Owner:</th><td>${submission.owner || 'N/A'}</td></tr>
                                    <tr><th>Source Organism:</th><td>${submission.source_organism || 'N/A'}</td></tr>
                                    <tr><th>Location:</th><td>${submission.location || 'N/A'}</td></tr>
                                    <tr><th>Sequencing Type:</th><td>${submission.sequencing_type || 'N/A'}</td></tr>
                                    <tr><th>Sample Type:</th><td>${submission.sample_type || 'N/A'}</td></tr>
                                    <tr><th>Total Samples:</th><td><span class="badge bg-info">${submission.sample_count || submission.total_samples}</span></td></tr>
                                    <tr><th>PDF File:</th><td><small>${submission.pdf_filename}</small></td></tr>
                                    <tr><th>Scanned At:</th><td>${new Date(submission.scanned_at).toLocaleString()}</td></tr>
                                </table>
                            </div>
                            
                            <!-- Submission IDs -->
                            <div class="col-md-6">
                                <h6 class="text-primary mb-3">üîë Unique Identifiers</h6>
                                <table class="table table-sm">
                                    <tr><th width="30%">UUID:</th><td><small><code>${submission.submission_ids?.uuid || submission.uuid || 'N/A'}</code></small></td></tr>
                                    <tr><th>Short Ref:</th><td><code>${submission.submission_ids?.short_ref || submission.short_ref || 'N/A'}</code></td></tr>
                                    <tr><th>File Hash:</th><td style="word-break: break-all;"><small><code>${submission.submission_ids?.file_hash || submission.file_hash || 'N/A'}</code></small></td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Samples Table -->
                        <div class="mt-4">
                            <h6 class="text-primary mb-3">üß™ Samples (${submission.samples?.length || 0} total)</h6>
                    `;
                    
                    if (submission.samples && submission.samples.length > 0) {
                        detailHtml += `
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-striped">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Sample Name</th>
                                            <th>Volume (¬µL)</th>
                                            <th>Qubit (ng/¬µL)</th>
                                            <th>NanoDrop (ng/¬µL)</th>
                                            <th>A260/280</th>
                                            <th>A260/230</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        submission.samples.forEach((sample, idx) => {
                            detailHtml += `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td>${sample.name}</td>
                                    <td>${sample.volume_ul || '-'}</td>
                                    <td>${sample.qubit_conc || '-'}</td>
                                    <td>${sample.nanodrop_conc || '-'}</td>
                                    <td>${sample.a260_280_ratio || '-'}</td>
                                    <td>${sample.a260_230_ratio || '-'}</td>
                                </tr>
                            `;
                        });
                        
                        detailHtml += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        detailHtml += '<p class="text-muted">No sample data available</p>';
                    }
                    
                    detailHtml += '</div><hr>';
                    
                    // Additional Information
                    detailHtml += `
                        <div class="mt-4">
                            <h6 class="text-primary mb-3">üìù Additional Information</h6>
                            <div class="row">
                    `;
                    
                    if (submission.additional_info && Object.keys(submission.additional_info).length > 0) {
                        const info = submission.additional_info;
                        
                        // Format additional info nicely
                        const infoItems = [
                            { label: 'Human DNA', value: info.contains_human_dna, icon: 'üß¨' },
                            { label: 'Flow Cell Type', value: info.flow_cell_type, icon: 'üíæ' },
                            { label: 'Genome Size (Mbp)', value: info.approx_genome_size, icon: 'üìè' },
                            { label: 'Coverage', value: info.coverage_needed, icon: 'üìä' },
                            { label: 'Estimated Flow Cells', value: info.estimated_flow_cells, icon: 'üî¢' },
                            { label: 'Basecalling', value: info.basecalling_method, icon: 'üñ•Ô∏è' },
                            { label: 'File Format', value: info.file_format, icon: 'üìÅ' },
                            { label: 'Notification Email', value: info.notification_email, icon: 'üìß' },
                            { label: 'Data Delivery', value: info.data_delivery, icon: 'üì¶' },
                            { label: 'Expected Reads/Sample', value: info.expected_reads_per_sample, icon: 'üìà' },
                            { label: 'Amplicon Length', value: info.amplicon_length, icon: 'üìê' },
                            { label: 'Comments', value: info.additional_comments, icon: 'üí¨' }
                        ];
                        
                        infoItems.forEach(item => {
                            if (item.value !== undefined && item.value !== null && item.value !== '') {
                                detailHtml += `
                                    <div class="col-md-6 mb-2">
                                        <strong>${item.icon} ${item.label}:</strong> ${item.value}
                                    </div>
                                `;
                            }
                        });
                    } else {
                        detailHtml += '<div class="col-12"><p class="text-muted">No additional information available</p></div>';
                    }
                    
                    detailHtml += `
                            </div>
                        </div>
                    `;
                    
                    // Update modal content
                    document.getElementById('detail-content').innerHTML = detailHtml;
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('detailModal'));
                    modal.show();
                }
            } catch (error) {
                console.error('Error loading detailed submission:', error);
                document.getElementById('detail-content').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading submission details. Please try again.
                    </div>
                `;
            }
        }
        
        // Download submission data as JSON
        function downloadSubmissionData() {
            if (!currentDetailedSubmission) return;
            
            const dataStr = JSON.stringify(currentDetailedSubmission, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `submission_${currentDetailedSubmission.submission_id}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Initialize
        async function init() {
            const apiOnline = await checkAPIStatus();
            if (apiOnline) {
                await loadStatistics();
            }
        }

        // Check API status every 10 seconds
        setInterval(checkAPIStatus, 10000);

        // Initialize on page load
        init();
    </script>
</body>
</html>
